/*******************************************************************************
 * Copyright 2020-2021 Exactpro (Exactpro Systems Limited)
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 ******************************************************************************/

package com.exactpro.th2.actuibackend


import Configuration
import com.fasterxml.jackson.databind.DeserializationFeature
import com.fasterxml.jackson.databind.ObjectMapper
import com.fasterxml.jackson.module.kotlin.jacksonObjectMapper
import io.ktor.http.*

@Suppress("MemberVisibilityCanBePrivate")
class Context(
    val args: Array<String>,
    val configuration: Configuration = Configuration(args),

    val timeout: Long = configuration.responseTimeout.value.toLong(),

    val jacksonMapper: ObjectMapper = jacksonObjectMapper()
        .enable(DeserializationFeature.FAIL_ON_READING_DUP_TREE_KEY)
        .disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES),

    //TODO(replace on get all proto schemas)
    val jsonService: Map<String, String> = mapOf(
       "act" to "eyJncnBjLWNoZWNrMS0yLjIuMS5qYXIiOnsidGgyX2dycGNfY2hlY2sxL2NoZWNrMS5wcm90byI6Ii8qXG4gKiBDb3B5cmlnaHQgMjAyMC0yMDIwIEV4YWN0cHJvIChFeGFjdHBybyBTeXN0ZW1zIExpbWl0ZWQpXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbnN5bnRheCA9IFwicHJvdG8zXCI7XG5cbmltcG9ydCBcInRoMl9ncnBjX2NvbW1vbi9jb21tb24ucHJvdG9cIjtcblxub3B0aW9uIGphdmFfbXVsdGlwbGVfZmlsZXMgPSB0cnVlO1xub3B0aW9uIGphdmFfcGFja2FnZSA9IFwiY29tLmV4YWN0cHJvLnRoMi5jaGVjazEuZ3JwY1wiO1xuXG5cbnNlcnZpY2UgQ2hlY2sxIHtcbiAgICBycGMgY3JlYXRlQ2hlY2twb2ludCAoQ2hlY2twb2ludFJlcXVlc3QpIHJldHVybnMgKENoZWNrcG9pbnRSZXNwb25zZSkge31cbiAgICBycGMgc3VibWl0Q2hlY2tSdWxlIChDaGVja1J1bGVSZXF1ZXN0KSByZXR1cm5zIChDaGVja1J1bGVSZXNwb25zZSkge31cbiAgICBycGMgc3VibWl0Q2hlY2tTZXF1ZW5jZVJ1bGUoQ2hlY2tTZXF1ZW5jZVJ1bGVSZXF1ZXN0KSByZXR1cm5zIChDaGVja1NlcXVlbmNlUnVsZVJlc3BvbnNlKSB7fVxufVxuXG5tZXNzYWdlIENoZWNrcG9pbnRSZXF1ZXN0IHtcbiAgICBzdHJpbmcgZGVzY3JpcHRpb24gPSAxO1xuICAgIEV2ZW50SUQgcGFyZW50X2V2ZW50X2lkID0gMjtcbn1cblxubWVzc2FnZSBDaGVja3BvaW50UmVzcG9uc2Uge1xuICAgIENoZWNrcG9pbnQgY2hlY2twb2ludCA9IDE7XG4gICAgUmVxdWVzdFN0YXR1cyBzdGF0dXMgPSAyO1xufVxuXG5tZXNzYWdlIENoYWluSUQge1xuICAgIHN0cmluZyBpZCA9IDE7XG59XG5cbm1lc3NhZ2UgQ2hlY2tSdWxlUmVxdWVzdCB7XG4gICAgQ29ubmVjdGlvbklEIGNvbm5lY3Rpdml0eV9pZCA9IDE7XG4gICAgTWVzc2FnZUZpbHRlciBmaWx0ZXIgPSAyO1xuICAgIENoZWNrcG9pbnQgY2hlY2twb2ludCA9IDM7IC8vIFJlZ2lzdGVyZWQgQ2hlY2twb2ludC4gSWYgdGhlIGNoYWluX2lkIGlzIGFsc28gc2V0IGluIHRoZSByZXF1ZXN0IHRoZSBjaGVja3BvaW50IHdpbGwgYmUgaWdub3JlZFxuICAgIGludDY0IHRpbWVvdXQgPSA0OyAvLyBUaW1lb3V0IGZvciBydWxlIGV4ZWN1dGlvblxuICAgIHJlc2VydmVkIDU7IC8vIFJlcG9ydElkIHJlcG9ydElkID0gNTsgcmVzZXJ2ZWQgbm93XG4gICAgRXZlbnRJRCBwYXJlbnRfZXZlbnRfaWQgPSA2O1xuICAgIHN0cmluZyBkZXNjcmlwdGlvbiA9IDc7XG4gICAgRGlyZWN0aW9uIGRpcmVjdGlvbiA9IDg7XG4gICAgQ2hhaW5JRCBjaGFpbl9pZCA9IDk7IC8vIFRoZSBjaGFpbiBpZCB0byBjb250aW51ZSBjaGVja2luZy5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgaXQncyBub3Qgc2V0IHRoZSBjaGVjayB3aWxsIGJlIHN0YXJ0ZWQgZnJvbSB0aGUgc3BlY2lmaWVkIGNoZWNrcG9pbnQgb3RoZXJ3aXNlIGNoZWNrcG9pbnQgd2lsbCBiZSBpZ25vcmVkXG59XG5cbm1lc3NhZ2UgQ2hlY2tSdWxlUmVzcG9uc2Uge1xuICAgIFJlcXVlc3RTdGF0dXMgc3RhdHVzID0gMTtcbiAgICBDaGFpbklEIGNoYWluX2lkID0gMjsgLy8gWW91IGNhbiB1c2UgaXQgdG8gdW5pdGUgdGhlIG5leHQgcnVsZSB0byB0aGUgY2hhaW4gd2l0aCBjdXJyZW50bHkgc3VibWl0dGVkIG9uZVxufVxuXG5tZXNzYWdlIENoZWNrU2VxdWVuY2VSdWxlUmVxdWVzdCB7XG4gICAgUHJlRmlsdGVyIHByZV9maWx0ZXIgPSAxO1xuICAgIHJlcGVhdGVkIE1lc3NhZ2VGaWx0ZXIgbWVzc2FnZV9maWx0ZXJzID0gMjtcbiAgICBDaGVja3BvaW50IGNoZWNrcG9pbnQgPSAzOyAvLyBSZWdpc3RlcmVkIENoZWNrcG9pbnQuIElmIHRoZSBjaGFpbl9pZCBpcyBhbHNvIHNldCBpbiB0aGUgcmVxdWVzdCB0aGUgY2hlY2twb2ludCB3aWxsIGJlIGlnbm9yZWRcbiAgICBpbnQ2NCB0aW1lb3V0ID0gNDsgLy8gVGltZW91dCBmb3IgcnVsZSBleGVjdXRpb25cbiAgICBDb25uZWN0aW9uSUQgY29ubmVjdGl2aXR5X2lkID0gNTtcbiAgICByZXNlcnZlZCA2OyAvLyBSZXBvcnRJZCByZXBvcnRJZCA9IDU7IHJlc2VydmVkIG5vd1xuICAgIEV2ZW50SUQgcGFyZW50X2V2ZW50X2lkID0gNztcbiAgICBib29sIGNoZWNrX29yZGVyID0gODtcbiAgICBzdHJpbmcgZGVzY3JpcHRpb24gPSA5O1xuICAgIERpcmVjdGlvbiBkaXJlY3Rpb24gPSAxMDtcbiAgICBDaGFpbklEIGNoYWluX2lkID0gMTE7IC8vIFRoZSBjaGFpbiBpZCB0byBjb250aW51ZSBjaGVja2luZy5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIGl0J3Mgbm90IHNldCB0aGUgY2hlY2sgd2lsbCBiZSBzdGFydGVkIGZyb20gdGhlIHNwZWNpZmllZCBjaGVja3BvaW50IG90aGVyd2lzZSBjaGVja3BvaW50IHdpbGwgYmUgaWdub3JlZFxufVxuXG5tZXNzYWdlIENoZWNrU2VxdWVuY2VSdWxlUmVzcG9uc2Uge1xuICAgIFJlcXVlc3RTdGF0dXMgc3RhdHVzID0gMTtcbiAgICBDaGFpbklEIGNoYWluX2lkID0gMjsgLy8gWW91IGNhbiB1c2UgaXQgdG8gdW5pdGUgdGhlIG5leHQgcnVsZSB0byB0aGUgY2hhaW4gd2l0aCBjdXJyZW50bHkgc3VibWl0dGVkIG9uZVxufVxuXG5tZXNzYWdlIFByZUZpbHRlciB7XG4gICAgbWFwPHN0cmluZywgVmFsdWVGaWx0ZXI+IGZpZWxkcyA9IDI7XG59XG4ifSwiZ3JwYy1jb21tb24tMi4zLjIuamFyIjp7InRoMl9ncnBjX2NvbW1vbi9jb21tb24ucHJvdG8iOiIvKlxuICogQ29weXJpZ2h0IDIwMjAtMjAyMCBFeGFjdHBybyAoRXhhY3Rwcm8gU3lzdGVtcyBMaW1pdGVkKVxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5zeW50YXggPSAncHJvdG8zJztcblxuaW1wb3J0IFwiZ29vZ2xlL3Byb3RvYnVmL3RpbWVzdGFtcC5wcm90b1wiO1xuXG5vcHRpb24gamF2YV9tdWx0aXBsZV9maWxlcyA9IHRydWU7XG5vcHRpb24gamF2YV9wYWNrYWdlID0gXCJjb20uZXhhY3Rwcm8udGgyLmNvbW1vbi5ncnBjXCI7XG5cbi8vLS0vLyBNZXRhZGF0YSBzdHJ1Y3R1cmVzIC8vLS0vL1xuXG5tZXNzYWdlIENvbm5lY3Rpb25JRCB7XG4gIHN0cmluZyBzZXNzaW9uX2FsaWFzID0gMTsgLy8gU2Vzc2lvbiBpZGVudGlmaWVyIGRlcGVuZHMgb24gcHJvdG9jb2wsIHRhcmdldCAvIHNlbmRlclxufVxuXG5lbnVtIERpcmVjdGlvbiB7XG4gIEZJUlNUID0gMDsgLy8gSW5jb21pbmcgbWVzc2FnZSBmb3IgY29ubmVjdGl2aXR5XG4gIFNFQ09ORCA9IDE7IC8vIE91dGdvaW5nIG1lc3NhZ2UgZm9yIGNvbm5lY3Rpdml0eVxufVxuXG5tZXNzYWdlIE1lc3NhZ2VJRCB7XG4gIENvbm5lY3Rpb25JRCBjb25uZWN0aW9uX2lkID0gMTtcbiAgRGlyZWN0aW9uIGRpcmVjdGlvbiA9IDI7IC8vIFRyYW5zcG9ydCBkaXJlY3Rpb24uXG4gIGludDY0IHNlcXVlbmNlID0gMzsgLy8gVW5pcXVlIHNlcXVlbmNlIG51bWJlciBpbiBzZXNzaW9uXG59XG5cbm1lc3NhZ2UgTWVzc2FnZU1ldGFkYXRhIHtcbiAgTWVzc2FnZUlEIGlkID0gMTsgLy8gTWVzc2FnZSBpZCBzaG91bGQgYmUgdW5pcXVlIGluIHNlc3Npb25cbiAgZ29vZ2xlLnByb3RvYnVmLlRpbWVzdGFtcCB0aW1lc3RhbXAgPSAyOyAvLyBNZXNzYWdlIGNyZWF0aW9uIHRpbWVzdGFtcFxuICBzdHJpbmcgbWVzc2FnZV90eXBlID0gMzsgLy8gTWVzc2FnZSB0eXBlIGJ5IGRpY3Rpb25hcnlcbiAgbWFwPHN0cmluZywgc3RyaW5nPiBwcm9wZXJ0aWVzID0gNDsgLy8gQWRkaXRpb25hbCBwcm9wZXJ0aWVzIGZvciB0aGUgbWVzc2FnZVxufVxuXG5tZXNzYWdlIFJhd01lc3NhZ2VNZXRhZGF0YSB7XG4gIE1lc3NhZ2VJRCBpZCA9IDE7IC8vIE1lc3NhZ2UgaWQgc2hvdWxkIGJlIHVuaXF1ZSBpbiBzZXNzaW9uXG4gIGdvb2dsZS5wcm90b2J1Zi5UaW1lc3RhbXAgdGltZXN0YW1wID0gMjsgLy8gTWVzc2FnZSBjcmVhdGlvbiB0aW1lc3RhbXBcbiAgbWFwPHN0cmluZywgc3RyaW5nPiBwcm9wZXJ0aWVzID0gMzsgLy8gQWRkaXRpb25hbCBwcm9wZXJ0aWVzIGZvciB0aGUgcmF3IG1lc3NhZ2Vcbn1cblxuLy8tLS8vIE1lc3NhZ2UgYm9keSBzdHJ1Y3R1cmUgLy8tLS8vXG5cbmVudW0gTnVsbFZhbHVlIHtcbiAgTlVMTF9WQUxVRSA9IDA7XG59XG5cbm1lc3NhZ2UgVmFsdWUge1xuICBvbmVvZiBraW5kIHtcbiAgICBOdWxsVmFsdWUgbnVsbF92YWx1ZSA9IDE7XG4gICAgc3RyaW5nIHNpbXBsZV92YWx1ZSA9IDI7XG4gICAgTWVzc2FnZSBtZXNzYWdlX3ZhbHVlID0gMztcbiAgICBMaXN0VmFsdWUgbGlzdF92YWx1ZSA9IDQ7XG4gIH1cbn1cblxubWVzc2FnZSBMaXN0VmFsdWUge1xuICByZXBlYXRlZCBWYWx1ZSB2YWx1ZXMgPSAxO1xufVxuXG4vLy0tLy8gTWVzc2FnZSAvIFJhdyBzdHJ1Y3R1cmVzIC8vLS0vL1xuXG5tZXNzYWdlIE1lc3NhZ2Uge1xuICBFdmVudElEIHBhcmVudF9ldmVudF9pZCA9IDM7IC8vIEl0IG1heWJlIHVzZWQgdG8gc3RvcmUgZXZlbnQgcmVsYXRlZCB0byBtZXNzYWdlIGxpZmUgY3ljbGVcbiAgTWVzc2FnZU1ldGFkYXRhIG1ldGFkYXRhID0gMTtcbiAgbWFwPHN0cmluZywgVmFsdWU+IGZpZWxkcyA9IDI7XG59XG5cbm1lc3NhZ2UgUmF3TWVzc2FnZSB7XG4gIFJhd01lc3NhZ2VNZXRhZGF0YSBtZXRhZGF0YSA9IDE7XG4gIGJ5dGVzIGJvZHkgPSAyO1xufVxuXG4vLy0tLy8gTWVzc2FnZSBiYXRjaCAvLy0tLy9cblxubWVzc2FnZSBNZXNzYWdlQmF0Y2gge1xuICByZXBlYXRlZCBNZXNzYWdlIG1lc3NhZ2VzID0gMTtcbn1cblxubWVzc2FnZSBSYXdNZXNzYWdlQmF0Y2gge1xuICByZXBlYXRlZCBSYXdNZXNzYWdlIG1lc3NhZ2VzID0gMTtcbn1cblxuLy8tLS8vIFJQQyBjYWxsIHJlc3BvbnNlIC8vLS0vL1xuXG5tZXNzYWdlIFJlcXVlc3RTdGF0dXMge1xuICBlbnVtIFN0YXR1cyB7XG4gICAgU1VDQ0VTUyA9IDA7XG4gICAgRVJST1IgPSAxO1xuICB9XG4gIFN0YXR1cyBzdGF0dXMgPSAxO1xuICBzdHJpbmcgbWVzc2FnZSA9IDI7XG59XG5cbi8vLS0vLyBTZXR0aW5ncyAvLy0tLy9cbmVudW0gRmFpbFVuZXhwZWN0ZWQge1xuICBOTyA9IDA7IC8vIGNvbXBhcmlzb24gd29uJ3QgZmFpbCBpbiBjYXNlIG9mIHVuZXhwZWN0ZWQgZmllbGRzIG9yIG1lc3NhZ2VzXG4gIEZJRUxEUyA9IDE7IC8vIGNvbXBhcmlzb24gd2lsbCBmYWlsIGluIGNhc2Ugb2YgdW5leHBlY3RlZCBmaWVsZHMgb25seVxuICBGSUVMRFNfQU5EX01FU1NBR0VTID0gMjsgLy8gY29tcGFyaXNvbiB3aWxsIGZhaWwgaW4gY2FzZSBvZiB1bmV4cGVjdGVkIGZpZWxkcyBvciBtZXNzYWdlc1xufVxuXG5tZXNzYWdlIENvbXBhcmlzb25TZXR0aW5ncyB7XG4gIC8qXG4gICogVGhlc2UgZmllbGRzIHdpbGwgbm90IGJlIGNvbnNpZGVyZWQgZHVyaW5nIGNvbXBhcmlzb24uIEl0IGNvbmNlcm5zIGZpZWxkcyB3aXRoIHNpbXBsZSBvciBjb2xsZWN0aW9uIHR5cGVzLlxuICAqIENvbXBhcmlzb24gcmVzdWx0IHdpbGwgaGF2ZSB0aGUgTkEgc3RhdHVzIGZvciB0aGVtLlxuICAqL1xuICByZXBlYXRlZCBzdHJpbmcgaWdub3JlX2ZpZWxkcyA9IDE7XG4gIEZhaWxVbmV4cGVjdGVkIGZhaWxfdW5leHBlY3RlZCA9IDI7XG59XG5cbi8vLS0vLyBNZXNzYWdlIGZpbHRlciAvLy0tLy9cblxuZW51bSBGaWx0ZXJPcGVyYXRpb24ge1xuICBFUVVBTCA9IDA7XG4gIE5PVF9FUVVBTCA9IDE7XG4gIEVNUFRZID0gMjtcbiAgTk9UX0VNUFRZID0gMztcbn1cblxubWVzc2FnZSBWYWx1ZUZpbHRlciB7XG4gIEZpbHRlck9wZXJhdGlvbiBvcGVyYXRpb24gPSAxO1xuICBib29sIGtleSA9IDI7XG4gIG9uZW9mIGtpbmQge1xuICAgIHN0cmluZyBzaW1wbGVfZmlsdGVyID0gMztcbiAgICBNZXNzYWdlRmlsdGVyIG1lc3NhZ2VfZmlsdGVyID0gNDtcbiAgICBMaXN0VmFsdWVGaWx0ZXIgbGlzdF9maWx0ZXIgPSA1O1xuICB9XG59XG5cbm1lc3NhZ2UgTGlzdFZhbHVlRmlsdGVyIHtcbiAgcmVwZWF0ZWQgVmFsdWVGaWx0ZXIgdmFsdWVzID0gMTtcbn1cblxubWVzc2FnZSBNZXNzYWdlRmlsdGVyIHtcbiAgc3RyaW5nIG1lc3NhZ2VUeXBlID0gMTtcbiAgc3RyaW5nIGRpcmVjdGlvbiA9IDI7XG4gIG1hcDxzdHJpbmcsIFZhbHVlRmlsdGVyPiBmaWVsZHMgPSAzO1xuICBDb21wYXJpc29uU2V0dGluZ3MgY29tcGFyaXNvbl9zZXR0aW5ncyA9IDQ7XG59XG5cbi8vLS0vLyBDaGVja3BvaW50IC8vLS0vL1xuXG5tZXNzYWdlIENoZWNrcG9pbnQge1xuICBzdHJpbmcgaWQgPSAxO1xuICBtYXA8c3RyaW5nLCBEaXJlY3Rpb25DaGVja3BvaW50PiBzZXNzaW9uX2FsaWFzX3RvX2RpcmVjdGlvbl9jaGVja3BvaW50ID0gMjtcblxuICBtZXNzYWdlIERpcmVjdGlvbkNoZWNrcG9pbnQge1xuICAgIG1hcDxpbnQzMiwgaW50NjQ+IGRpcmVjdGlvbl90b19zZXF1ZW5jZSA9IDE7XG4gIH1cbn1cblxuLy8tLS8vIEV2ZW50IC8vLS0vL1xuZW51bSBFdmVudFN0YXR1cyB7XG4gIFNVQ0NFU1MgPSAwO1xuICBGQUlMRUQgPSAxO1xufVxuXG5tZXNzYWdlIEV2ZW50SUQge1xuICBzdHJpbmcgaWQgPSAxOyAvLyBVbmlxdWUgZXZlbnQgaWQgaW4gVEgyIGRlcGxveVxufVxuXG5tZXNzYWdlIEV2ZW50IHtcbiAgRXZlbnRJRCBpZCA9IDE7XG4gIEV2ZW50SUQgcGFyZW50X2lkID0gMjsgLy8gRXZlbnQgaWQgb2YgcGFyZW50IGV2ZW50LiBJdCBpcyBudWxsIGZvciByb290IGV2ZW50XG4gIGdvb2dsZS5wcm90b2J1Zi5UaW1lc3RhbXAgc3RhcnRfdGltZXN0YW1wID0gMztcbiAgZ29vZ2xlLnByb3RvYnVmLlRpbWVzdGFtcCBlbmRfdGltZXN0YW1wID0gNDtcbiAgRXZlbnRTdGF0dXMgc3RhdHVzID0gNTsgLy8gQWdncmVnYXRlZCBzdGF0dXMgb2YgY3VycmVudCBhbmQgY2hpbGRyZW4gZXZlbnRzIHdoaWNoIHN5bmMgd3JpdHRlbi5cbiAgc3RyaW5nIG5hbWUgPSA2O1xuICBzdHJpbmcgdHlwZSA9IDc7XG4gIGJ5dGVzIGJvZHkgPSA4O1xuICByZXBlYXRlZCBNZXNzYWdlSUQgYXR0YWNoZWRfbWVzc2FnZV9pZHMgPSA5O1xufVxuXG5tZXNzYWdlIEV2ZW50QmF0Y2gge1xuICBFdmVudElEIHBhcmVudF9ldmVudF9pZCA9IDE7XG4gIHJlcGVhdGVkIEV2ZW50IGV2ZW50cyA9IDI7IC8vIEV2ZW50cyBvcHRpb25hbCByZWxhdGVkIHRvIGJldHdlZW4gdGhlbXNlbHZlcy4gTm8gZXZlbnRzIG91dHNpZGUgdGhpcyBiYXRjaCBzaG91bGQgcmVmZXIgdG8gdGhlIGV2ZW50cyBpbiB0aGlzIGJhdGNoLlxufVxuIn0sImdycGMtYWN0LXRlbXBsYXRlLTIuMy4wLmphciI6eyJ0aDJfZ3JwY19hY3RfdGVtcGxhdGUvYWN0X3RlbXBsYXRlLnByb3RvIjoiLypcbiAqIENvcHlyaWdodCAyMDIwLTIwMjAgRXhhY3Rwcm8gKEV4YWN0cHJvIFN5c3RlbXMgTGltaXRlZClcbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuc3ludGF4ID0gXCJwcm90bzNcIjtcblxuaW1wb3J0IFwidGgyX2dycGNfY29tbW9uL2NvbW1vbi5wcm90b1wiO1xuXG5vcHRpb24gamF2YV9tdWx0aXBsZV9maWxlcyA9IHRydWU7XG5vcHRpb24gamF2YV9wYWNrYWdlID0gXCJjb20uZXhhY3Rwcm8udGgyLmFjdC5ncnBjXCI7XG5cbnNlcnZpY2UgQWN0IHtcbiAgLyogVGhpcyBhY3Rpb24gZXhlY3V0ZXMgbmV4dCBzdGVwczpcbiAgICAgIDEpIFJlZ2lzdGVycyBjaGVja3BvaW50IGluIFZlcmlmaWVyIG1pY3Jvc2VydmljZVxuICAgICAgMikgU2VuZHMgcGFzc2VkIG1lc3NhZ2UgYXMgaXMgdG8gQ29ubmVjdGl2aXR5IG1pY3Jvc2VydmljZVxuICAgICAgMykgV2FpdHMgRXhlY3V0aW9uIFJlcG9ydCBvciBCdXNpbmVzcyBNZXNzYWdlIFJlamVjdCB3aXRoIHRoZSBzYW1lIENsT3JkSUQgYXMgaW4gcGFzc2VkIG1lc3NhZ2VcbiAgICAgICAgICBmcm9tIENvbm5lY3Rpdml0eSBtaWNyb3NlcnZpY2VcbiAgICAgIDQpIFJldHVybnMgdGhlIG1lc3NhZ2UgcmVwb3NlIGFuZCB0aGUgQ2hlY2twb2ludCAqL1xuICBycGMgcGxhY2VPcmRlckZJWCAoUGxhY2VNZXNzYWdlUmVxdWVzdCkgcmV0dXJucyAoUGxhY2VNZXNzYWdlUmVzcG9uc2UpIHtcbiAgfVxuXG4gIC8qU2VuZCBmaXggbWVzc2FnZSB3aXRob3V0IHJlc3BvbnNlIGF3YWl0aW5nICovXG4gIHJwYyBzZW5kTWVzc2FnZSAoUGxhY2VNZXNzYWdlUmVxdWVzdCkgcmV0dXJucyAoU2VuZE1lc3NhZ2VSZXNwb25zZSkge1xuICB9XG5cbiAgcnBjIHBsYWNlUXVvdGVSZXF1ZXN0RklYIChQbGFjZU1lc3NhZ2VSZXF1ZXN0KSByZXR1cm5zIChQbGFjZU1lc3NhZ2VSZXNwb25zZSkge1xuICB9XG5cbiAgcnBjIHBsYWNlUXVvdGVGSVggKFBsYWNlTWVzc2FnZVJlcXVlc3QpIHJldHVybnMgKFBsYWNlTWVzc2FnZVJlc3BvbnNlKSB7XG4gIH1cblxuICBycGMgcGxhY2VPcmRlck1hc3NDYW5jZWxSZXF1ZXN0RklYIChQbGFjZU1lc3NhZ2VSZXF1ZXN0KSByZXR1cm5zIChQbGFjZU1lc3NhZ2VSZXNwb25zZSkge1xuICB9XG5cbiAgcnBjIHBsYWNlUXVvdGVDYW5jZWxGSVggKFBsYWNlTWVzc2FnZVJlcXVlc3QpIHJldHVybnMgKFBsYWNlTWVzc2FnZVJlc3BvbnNlKSB7XG4gIH1cblxuICBycGMgcGxhY2VRdW90ZVJlc3BvbnNlRklYIChQbGFjZU1lc3NhZ2VSZXF1ZXN0KSByZXR1cm5zIChQbGFjZU1lc3NhZ2VSZXNwb25zZSkge1xuICB9XG59XG5cbm1lc3NhZ2UgU2VuZE1lc3NhZ2VSZXNwb25zZSB7XG4gIFJlcXVlc3RTdGF0dXMgc3RhdHVzID0gMTtcbiAgQ2hlY2twb2ludCBjaGVja3BvaW50X2lkID0gMjtcbn1cblxubWVzc2FnZSBQbGFjZU1lc3NhZ2VSZXF1ZXN0IHtcbiAgTWVzc2FnZSBtZXNzYWdlID0gMTtcbiAgLyogUGxlYXNlIHNldCBjb25uZWN0aW9uX2lkIGludG8gbWVzc2FnZS4gQWN0IHRyYW5zZmVyIHRoaXMgdmFsdWUgaW50byBtZXNzYWdlXG4gICAqIGF1dG9tYXRpY2FsbHkgaWYgbWVzc2FnZSBoYXNuJ3QgY29ubmVjdGl2aXR5SUQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkgKi9cbiAgQ29ubmVjdGlvbklEIGNvbm5lY3Rpb25faWQgPSAyW2RlcHJlY2F0ZWQgPSB0cnVlXTtcbiAgRXZlbnRJRCBwYXJlbnRfZXZlbnRfaWQgPSA0O1xuICBzdHJpbmcgZGVzY3JpcHRpb24gPSA1O1xufVxuXG5tZXNzYWdlIFBsYWNlTWVzc2FnZVJlc3BvbnNlIHtcbiAgTWVzc2FnZSByZXNwb25zZV9tZXNzYWdlID0gMTtcbiAgUmVxdWVzdFN0YXR1cyBzdGF0dXMgPSAyO1xuICBDaGVja3BvaW50IGNoZWNrcG9pbnRfaWQgPSAzO1xufVxuIn19"
    ),

    val cacheControl: CacheControl.MaxAge = configuration.clientCacheTimeout.value.toInt().let {
        CacheControl.MaxAge(
            visibility = CacheControl.Visibility.Public,
            maxAgeSeconds = it,
            mustRevalidate = false,
            proxyRevalidate = false,
            proxyMaxAgeSeconds = it
        )
    }
)
